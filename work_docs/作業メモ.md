# 作業メモ

## そもそもの前提

- [java-sdk](https://github.com/modelcontextprotocol/java-sdk)をライブラリとしてビルドする
  - 以下手順を踏むとMavenのローカルリポジトリへのインストールまで実施してくれる
- 別途MCPサーバー用のプロジェクトを作成し、そこから依存関係を定義して使用する
  - java-sdk自体に手を入れて、MCPサーバーを作成するわけではない

## 環境の前提

- Windows環境+Java17JDK
- Mavenは無くてもビルド時に自動的に取得。Maven Wrapperというツールで実現している

## 最初のビルド

1. コードをclone
2. Java17 JDKにJavaのパスと、Java_Homeを設定
   - このプロジェクトのみで有効にするため`.vscode/settigs.json'にパスを記載

    ```json
    {
        "terminal.integrated.env.windows": {
            "JAVA_HOME": "C:\\java\\jdk-17",
            "PATH": "${env:PATH};C:\\java\\jdk-17\\bin"
        },
        "java.jdt.ls.java.home": "C:\\java\\jdk-17"
    }
    ```

3. `.\mvnw.cmd clean install -DskipTests`を実行すると、ビルドが成功した。
   - 最初に実行した際、一時ファイルへのアクセスセラーとなった。
   - `Remove-Item -Path "$env:TEMP\tmp*.tmp.dir" -Recurse -Force -ErrorAction SilentlyContinue`を実行したら解消された。
   - ゴミファイルが残っていたかもしれない。

---
Tips:

Mavenビルドの成果物は、各モジュールの `target` ディレクトリに保存される。

`.mvnw.cmd clean install -DskipTests` を実行した場合、以下の場所にJARファイルが生成される:

**主要な成果物の保存場所:**

1. **mcp-core** モジュール
   - `mcp-core\target\mcp-core-<version>.jar`

2. **mcp-json** モジュール
   - `mcp-json\target\mcp-json-<version>.jar`

3. **mcp-json-jackson2** モジュール
   - `mcp-json-jackson2\target\mcp-json-jackson2-<version>.jar`

4. **mcp-spring-webflux** モジュール
   - `mcp-spring\mcp-spring-webflux\target\mcp-spring-webflux-<version>.jar`

5. **mcp-spring-webmvc** モジュール
   - `mcp-spring\mcp-spring-webmvc\target\mcp-spring-webmvc-<version>.jar`

6. **mcp-test** モジュール
   - `mcp-test\target\mcp-test-<version>.jar`

また、`install` フェーズを実行しているため、これらの成果物はローカルのMavenリポジトリにもインストールされる:

- **Windowsの場合**: `C:\Users\<ユーザー名>\.m2\repository\io\modelcontextprotocol\...`

各 `target` ディレクトリ内の `maven-archiver/pom.properties` ファイルで、ビルドされたバージョン番号を確認できる。

---

## MCPのベースとなるプロジェクトの作成

1. `drsum-java-mcp`フォルダを作成。ここに新しいmavenプロジェクト作成
2. ここでもMaven Wrapperを使うため、.mvnフォルダ、mvnw、mvnw.cmdをjava-sdkからコピー
3. java-sdk、ログ、テストの依存関係をpom.xmlに記載
4. `.\mvnw.cmd clean package`で、ビルド及びjar作成
   1. 依存するライブラリを全部含めるfat.jarも一緒に作成するようにした

## DrSumEA.jarの組み込み

1. local mavenリポジトリへのインストール

   ```powershell
   # groupIdにドットが含まれる場合は、各パラメータをダブルクォートで囲む必要がある
   .\mvnw.cmd install:install-file "-Dfile=C:\DrSum57\DevKit\java\api\DrSumEA.jar" "-DgroupId=jp.co.dw_sapporo" "-DartifactId=DrSumEA" "-Dversion=5.7.0" "-Dpackaging=jar"
   ```

   > **Note**: PowerShellでは、groupIdに`.`が含まれる場合、パラメータ全体をダブルクォートで囲む必要があります。

2. pom.xmlへの依存関係の追加

   ```xml
   <dependency>
       <groupId>jp.co.dw_sapporo</groupId>
       <artifactId>DrSumEA</artifactId>
       <version>5.7.0</version>
   </dependency>
   ```

      インストール先: `C:\Users\<ユーザー名>\.m2\repository\jp\co\dw_sapporo\DrSumEA\5.7.0\`

3. 実装計画の策定と実装
   - ここからはCopilotにやってもらった。
   - plan.mdに要件と機能的な制約を記載し、実装計画とTODOリストを作成してもらう
   - DrSumEA.jarの仕様は`work_docs/JPN`配下に配置

---

## 2024/10/14 実装計画策定

1. **要件と現状の把握**
   - ✅ plan.mdの要件確認
   - ✅ 現在のDrSumMcpServer.javaの実装確認
   - ✅ DrSumEA.jarのAPIドキュメント確認
   - ✅ サンプルコード（ExampleDbi.java、ExampleMdi.java）の確認

2. **DrSumEA.jar API調査結果**
   - **主要クラス**: DWDbiConnection, DWDbiCursor, DWColumnInfo, DWTableInfo など
   - **接続方法**: `new DWDbiConnection(host, port, username, password)` → `openDatabase(dbName)`
   - **メタ情報取得**: `getSchema()`, `getTableList()`, `getDatabaseList()`
   - **クエリー実行**: `cursor()` → `execute(sql)` → `fetchmany(n)`
   - **例外処理**: DWException を catch

3. **実装計画の完成**
   - ✅ 6つのPhaseに分けた詳細TODO作成
   - ✅ SOLID原則に基づいた設計（内部クラスで実装）
   - ✅ 具体的なコード例の提示
   - ✅ 技術的考慮事項の整理

4. **設計方針**
   - DrSumMcpServer.java内で完結（最小限実装）
   - 内部クラスでの責任分離：
     - ConnectionConfig: 接続設定保持
     - DrSumConnection: 接続管理
     - DrSumMetadataService: メタ情報取得
     - DrSumQueryService: クエリー実行
   - パスワードの秘匿化を実装
   - サンプルデータはデフォルト3行

5. **MCPツール設計**
   - configure_connection: Dr.Sum接続設定
   - get_metadata: テーブルメタ情報+サンプルデータ取得
   - execute_query: SQLクエリ実行
   - disconnect: 接続切断

6. **次のステップ**
   - Phase 1: リファクタリング
   - Phase 2: Dr.Sum接続機能実装（最優先）
   - Phase 3-6: 順次実装+テスト

**参考資料**
- DrSumEA.jar APIドキュメント: `work_docs/JPN/doc/`
- サンプルコード: `work_docs/JPN/example/`
- 実装計画: `work_docs/plan.md`

````
